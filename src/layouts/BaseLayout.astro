---
import "../styles/global.css";
import AnimatedGradientBackground from "../components/AnimatedGradientBackground.astro";
import BackgroundGlow from "../components/BackgroundGlow.astro";
// import ThemeToggle from "../components/ThemeToggle";

interface Props {
  title?: string;
}

const { title = "Bryce Kennedy – Portfolio" } = Astro.props;
const base = import.meta.env.BASE_URL;
---

<html lang="en" class="dark">
  <head>
    <meta charset="utf-8" />
    <title>{title}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href={`${base}favicon.svg`} />
    <style>
      @view-transition {
        navigation: auto;
      }

      /* Header - sticky, initially hidden above viewport */
      .site-header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 40;
        background: rgba(7, 10, 20, 0.95);
        backdrop-filter: blur(6px);
        border-bottom: 1px solid rgba(55, 65, 81, 0.2);
        transform: translateY(-100%);
        transition: transform 0.3s ease;
      }

      /* Pre-show header if it was visible (set via inline script) */
      .site-header.header--preload {
        transform: translateY(0);
        transition: none;
      }

      /* Header visible when scrolled past hero */
      .site-header.header--visible {
        transform: translateY(0);
      }

      .header-inner {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
      }

      .header-profile {
        width: 2.5rem;
        height: 2.5rem;
      }

      .header-profile img {
        display: block;
      }

      /* Hero slot styling */
      ::slotted([slot="hero"]) {
        display: block;
        width: 100%;
      }

      /* Tagline animation for mobile */
      .tagline-container {
        position: relative;
        height: 1rem;
        overflow: visible;
        display: block;
      }

      .tagline-item {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        opacity: 0;
        animation: taglineCycle 15s infinite ease-in-out;
        white-space: nowrap;
        transition: opacity 1s ease-in-out;
      }

      .tagline-item:nth-child(1) {
        animation-delay: 0s;
      }

      .tagline-item:nth-child(2) {
        animation-delay: 5s;
      }

      .tagline-item:nth-child(3) {
        animation-delay: 10s;
      }

      @keyframes taglineCycle {
        0% {
          opacity: 0;
        }
        5% {
          opacity: 1;
        }
        28% {
          opacity: 1;
        }
        33% {
          opacity: 0;
        }
        100% {
          opacity: 0;
        }
      }

      /* Show static tagline on desktop */
      @media (min-width: 768px) {
        .tagline-container {
          height: auto;
        }

        .tagline-item {
          position: static;
          opacity: 1;
          animation: none;
          display: inline;
        }

        .tagline-item:not(:last-child)::after {
          content: " · ";
        }
      }
    </style>
  </head>
  <body class="min-h-screen bg-surface-dark text-text-light">
    <AnimatedGradientBackground />
    <div class="min-h-screen flex flex-col">
      <header
        class="site-header border-b border-gray-dark/70 bg-surface-dark/90 backdrop-blur transition-all"
        id="site-header"
      >
        <script is:inline>
          // Run immediately to prevent animation flash
          if (sessionStorage.getItem("headerVisible") === "true") {
            document.getElementById("site-header").classList.add("header--preload");
          }
        </script>
        <div class="max-w-5xl mx-auto px-4 header-inner">
          <div
            class="topbar flex items-center justify-between gap-4 py-6 md:py-4"
          >
            <div class="flex items-center gap-4">
              <a
                href={base}
                class="flex items-center gap-3 font-semibold tracking-tight"
              >
                <div
                  class="header-profile w-10 h-10 md:w-12 md:h-12 rounded-full overflow-hidden border-2 border-brand-orange"
                >
                  <img
                    src={`${base}images/profile-small.jpg`}
                    alt="Bryce Kennedy"
                    class="w-full h-full object-cover"
                  />
                </div>
                <div class="flex flex-col justify-start">
                  <div
                    class="text-xs uppercase tracking-[0.25em] text-sky-300/80 tagline-container block"
                    style="font-size:.6rem;"
                  >
                    <span class="tagline-item">UX Engineering</span>
                    <span class="tagline-item">Frontend Development</span>
                    <span class="tagline-item">Content Management Systems</span>
                  </div>
                  <span class="header-name inline">Bryce Kennedy</span>
                </div>
              </a>
            </div>

            <nav class="flex items-center gap-4 text-sm header-nav">
              <a
                href="#projects"
                class="hover:text-brand-orange transition-colors">Projects</a
              >
              <a href="#about" class="hover:text-brand-orange transition-colors"
                >About</a
              >
            </nav>
          </div>
        </div>
      </header>

      <!-- Hero section from page -->
      <slot name="hero" />

      <main class="flex-1">
        <slot />
      </main>

      <footer class="border-t border-gray-dark/70 py-4 text-xs text-text-muted">
        <div class="max-w-5xl mx-auto px-4 flex justify-between items-center">
          <span>© {new Date().getFullYear()} Bryce Kennedy</span>

          <span class="flex items-center gap-3">
            <span class="text-text-muted mr-1">Built with</span>

            <a
              href="https://astro.build"
              target="_blank"
              rel="noopener noreferrer"
              class="text-text-muted hover:text-brand-orange transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2 focus-visible:ring-offset-surface-dark"
              aria-label="Astro"
              title="Astro"
            >
              <img
                src={`${base}icons/astro-svgrepo-com.svg`}
                alt="Astro"
                class="w-6 h-6 brightness-0 invert"
              />
            </a>

            <a
              href="https://react.dev"
              target="_blank"
              rel="noopener noreferrer"
              class="text-text-muted hover:text-brand-orange transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2 focus-visible:ring-offset-surface-dark"
              aria-label="React"
              title="React"
            >
              <img
                src={`${base}icons/react-svgrepo-com.svg`}
                alt="React"
                class="w-6 h-6 brightness-0 invert"
              />
            </a>

            <a
              href="https://rive.app"
              target="_blank"
              rel="noopener noreferrer"
              class="text-text-muted hover:text-brand-orange transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-orange focus-visible:ring-offset-2 focus-visible:ring-offset-surface-dark"
              aria-label="Rive"
              title="Rive"
            >
              <img
                src={`${base}icons/rive_square.svg`}
                alt="Rive"
                class="w-6 h-6 brightness-0 invert"
              />
            </a>
          </span>
        </div>
      </footer>
    </div>

    <script>
      // Wait for DOM to be fully loaded before initializing
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initScrollListener);
      } else {
        initScrollListener();
      }

      function initScrollListener() {
        const header = document.querySelector(".site-header");

        if (!header) {
          console.error("Header element not found");
          return;
        }

        console.log("Header initialized for scroll detection");

        // Find the hero section by id (section with id="test" in index.astro)
        const heroElement =
          document.querySelector('[slot="hero"]') ||
          document.querySelector("section#test");

        // If there's no hero section, always show the header
        if (!heroElement) {
          header.classList.remove("header--preload");
          header.classList.add("header--visible");
          sessionStorage.setItem("headerVisible", "true");
          console.log("No hero section found - header always visible");
          return;
        }

        // If header was preloaded as visible, convert to visible state
        if (header.classList.contains("header--preload")) {
          header.classList.remove("header--preload");
          header.classList.add("header--visible");
        }

        let ticking = false;

        const updateHeaderVisibility = () => {
          if (heroElement) {
            const heroRect = heroElement.getBoundingClientRect();
            const shouldShowHeader = heroRect.bottom < 0;

            console.log(
              "Hero bottom:",
              heroRect.bottom,
              "Should show header:",
              shouldShowHeader,
            );

            // Only update if state changed
            const hasClass = header.classList.contains("header--visible");
            if (shouldShowHeader !== hasClass) {
              header.classList.toggle("header--visible", shouldShowHeader);
              sessionStorage.setItem("headerVisible", shouldShowHeader ? "true" : "false");
              console.log(
                "Header class toggled. Has header--visible:",
                header.classList.contains("header--visible"),
              );
            }
          }
          ticking = false;
        };

        window.addEventListener(
          "scroll",
          () => {
            if (!ticking) {
              window.requestAnimationFrame(updateHeaderVisibility);
              ticking = true;
            }
          },
          { passive: true },
        );

        // Initial call
        updateHeaderVisibility();
      }

      // Save scroll position before navigating away
      document.addEventListener("click", (e) => {
        const link = (e.target as HTMLElement).closest("a");
        if (link && link.href && !link.href.includes("#")) {
          // Save current scroll position for this page
          const currentPath = window.location.pathname;
          sessionStorage.setItem(`scrollPos_${currentPath}`, window.scrollY.toString());
        }
      });

      // Restore scroll position when page loads
      window.addEventListener("load", () => {
        const currentPath = window.location.pathname;
        const savedScroll = sessionStorage.getItem(`scrollPos_${currentPath}`);

        // Only restore if there's no hash in the URL
        if (savedScroll && !window.location.hash) {
          window.scrollTo(0, parseInt(savedScroll));
        }
      });

      // Smooth scroll with offset
      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        anchor.addEventListener("click", function (e) {
          const href = anchor.getAttribute("href");
          if (href && href !== "#") {
            e.preventDefault();
            const target = document.querySelector(href);
            if (target) {
              const headerOffset = 80;
              const elementPosition = target.getBoundingClientRect().top;
              const offsetPosition =
                elementPosition + window.pageYOffset - headerOffset;

              window.scrollTo({
                top: offsetPosition,
                behavior: "smooth",
              });
            }
          }
        });
      });
    </script>
  </body>
</html>
